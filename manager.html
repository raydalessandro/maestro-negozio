<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Manager - Maestro di Negozio</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>👨‍💼 Dashboard Manager</h1>
            <p class="subtitle">Sistema di Monitoraggio Task</p>
        </div>

        <div class="back-button">
            <button class="btn btn-secondary" onclick="goHome()">← Indietro</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('tasks')">📋 Gestione Task</div>
            <div class="tab" onclick="switchTab('analytics')">📊 Analytics</div>
            <div class="tab" onclick="switchTab('leaderboard')">🏆 Classifica</div>
            <div class="tab" onclick="switchTab('history')">📂 Storico</div>
        </div>

        <!-- TAB GESTIONE TASK -->
        <div id="tab-tasks" class="tab-content active">
            <div class="month-controls">
                <button class="btn btn-secondary" onclick="previousMonth()">◀</button>
                <div class="month-display" id="currentMonth"></div>
                <button class="btn btn-secondary" onclick="nextMonth()">▶</button>
            </div>

            <div class="card">
                <h2>📋 Seleziona Persona</h2>
                <div class="person-selector">
                    <button class="person-btn" onclick="selectPerson('Gemy')">Gemy</button>
                    <button class="person-btn" onclick="selectPerson('Valeria')">Valeria</button>
                    <button class="person-btn" onclick="selectPerson('Riky')">Riky</button>
                </div>

                <div class="date-selector">
                    <label>📅 Data: </label>
                    <input type="date" id="taskDate" onchange="loadTasksForDate()">
                </div>
            </div>

            <div id="tasksList"></div>

            <div class="card">
                <div class="penalty-summary" id="penaltySummary">
                    <h3>📊 Riepilogo Penalità</h3>
                    <p>Seleziona le task non completate per vedere il totale</p>
                </div>
            </div>

            <div class="card action-buttons">
                <button class="btn btn-primary" onclick="saveTasksForToday()">💾 Salva Penalità</button>
                <button class="btn btn-secondary" onclick="clearSelection()">🔄 Resetta Selezione</button>
            </div>
        </div>

        <!-- TAB ANALYTICS -->
        <div id="tab-analytics" class="tab-content">
            <!-- Team Health Score -->
            <div class="card analytics-hero">
                <h2>🏥 Team Health Score</h2>
                <div id="teamHealthScore"></div>
            </div>

            <!-- Insights AI -->
            <div class="card">
                <h2>🤖 AI Insights</h2>
                <p style="opacity: 0.8; margin-bottom: 20px;">Analisi automatica basata sui dati raccolti</p>
                <div id="aiInsights"></div>
            </div>

            <!-- Grafici -->
            <div class="analytics-grid">
                <!-- Trend Punti -->
                <div class="card">
                    <h3>📈 Trend Punti (ultimi 30 giorni)</h3>
                    <canvas id="trendChart"></canvas>
                </div>

                <!-- Heatmap Task -->
                <div class="card">
                    <h3>🔥 Task Più Problematiche</h3>
                    <canvas id="heatmapChart"></canvas>
                </div>

                <!-- Pattern Giornalieri -->
                <div class="card">
                    <h3>📅 Errori per Giorno Settimana</h3>
                    <canvas id="weekdayChart"></canvas>
                </div>

                <!-- Comparazione Settimanale -->
                <div class="card">
                    <h3>⚖️ Questa Settimana vs Settimana Scorsa</h3>
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- Previsioni -->
            <div class="card">
                <h2>🔮 Previsioni Fine Mese</h2>
                <div id="predictions"></div>
            </div>

            <!-- Raccomandazioni Personalizzate -->
            <div class="card">
                <h2>💡 Raccomandazioni per Persona</h2>
                <div class="person-selector">
                    <button class="person-btn" onclick="showRecommendations('Gemy')">Gemy</button>
                    <button class="person-btn" onclick="showRecommendations('Valeria')">Valeria</button>
                    <button class="person-btn" onclick="showRecommendations('Riky')">Riky</button>
                </div>
                <div id="recommendations"></div>
            </div>

            <!-- Correlazioni -->
            <div class="card">
                <h2>🔗 Task Correlate</h2>
                <p style="opacity: 0.8; margin-bottom: 20px;">Task che vengono spesso saltate insieme</p>
                <div id="correlations"></div>
            </div>
        </div>

        <!-- TAB CLASSIFICA -->
        <div id="tab-leaderboard" class="tab-content">
            <div class="card">
                <h2>🏆 Classifica Attuale</h2>
                <div id="leaderboard" class="leaderboard"></div>
            </div>
        </div>

        <!-- TAB STORICO -->
        <div id="tab-history" class="tab-content">
            <div class="card">
                <h2>📊 Storico e Report</h2>
                <div class="history-controls">
                    <select id="historyPerson" onchange="loadHistory()">
                        <option value="all">Tutti</option>
                        <option value="Gemy">Gemy</option>
                        <option value="Valeria">Valeria</option>
                        <option value="Riky">Riky</option>
                    </select>
                    <input type="date" id="historyFromDate" onchange="loadHistory()">
                    <span>→</span>
                    <input type="date" id="historyToDate" onchange="loadHistory()">
                    <button class="btn btn-primary" onclick="loadHistory()">🔍 Filtra</button>
                </div>
                <div id="historyList"></div>
            </div>

            <div class="card">
                <h3>📄 Report e Gestione</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="generateWeeklyReport()">📄 Report Settimanale (PDF)</button>
                    <button class="btn btn-primary" onclick="generateMonthlyReport()">📊 Report Mensile (PDF)</button>
                    <button class="btn btn-secondary" onclick="resetMonth()">🔄 Reset Mese</button>
                </div>
                <p style="margin-top: 15px; opacity: 0.8; font-size: 0.95em;">
                    💡 I report si aprono in una nuova finestra. Usa Ctrl+P o Cmd+P per salvare come PDF.
                </p>
            </div>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/analytics.js"></script>
    <script src="assets/js/report.js"></script>
    <script>
        let selectedPerson = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let charts = {};

        function goHome() {
            window.location.href = 'index.html';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'leaderboard') updateLeaderboard();
            if (tabName === 'history') loadHistory();
            if (tabName === 'analytics') loadAnalytics();
        }

        function updateMonthDisplay() {
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('currentMonth').textContent = 
                `${monthNames[currentMonth]} ${currentYear}`;
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateMonthDisplay();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateMonthDisplay();
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('taskDate').value = today;
            document.getElementById('historyFromDate').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('historyToDate').value = today;
        }

        function selectPerson(person) {
            selectedPerson = person;
            document.querySelectorAll('.person-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            renderTasks();
        }

        function renderTasks() {
            if (!selectedPerson) {
                document.getElementById('tasksList').innerHTML = 
                    '<div class="card"><p style="text-align:center; font-size:1.2em;">👆 Seleziona una persona per iniziare</p></div>';
                return;
            }

            let html = '';
            for (const [category, taskList] of Object.entries(tasks)) {
                html += `
                    <div class="card">
                        <div class="task-category">
                            <div class="category-header">${category}</div>
                            ${taskList.map((task, idx) => `
                                <div class="task-item">
                                    <input type="checkbox" id="task-${category}-${idx}" 
                                           data-points="${task.points}"
                                           data-task="${task.name}"
                                           onchange="updatePenaltySummary()">
                                    <label for="task-${category}-${idx}">${task.name}</label>
                                    <span class="task-points">-${task.points} PP</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            document.getElementById('tasksList').innerHTML = html;
            loadTasksForDate();
        }

        function loadTasksForDate() {
            const date = document.getElementById('taskDate').value;
            if (!selectedPerson || !date) return;

            const data = getData();
            const personData = data[selectedPerson];
            const dayRecord = personData.history.find(h => h.date === date);

            document.querySelectorAll('#tasksList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });

            if (dayRecord && dayRecord.incompleteTasks) {
                dayRecord.incompleteTasks.forEach(taskName => {
                    const checkbox = Array.from(document.querySelectorAll('#tasksList input[type="checkbox"]'))
                        .find(cb => cb.dataset.task === taskName);
                    if (checkbox) checkbox.checked = true;
                });
            }
            updatePenaltySummary();
        }

        function updatePenaltySummary() {
            const checkboxes = document.querySelectorAll('#tasksList input[type="checkbox"]:checked');
            let totalPenalty = 0;
            let taskCount = checkboxes.length;

            checkboxes.forEach(cb => {
                totalPenalty += parseInt(cb.dataset.points);
            });

            const summaryDiv = document.getElementById('penaltySummary');
            if (taskCount === 0) {
                summaryDiv.innerHTML = `
                    <h3>✅ Nessuna penalità</h3>
                    <p>Tutte le task completate!</p>
                `;
            } else {
                const data = getData();
                const newPoints = data[selectedPerson].points - totalPenalty;
                summaryDiv.innerHTML = `
                    <h3>⚠️ Riepilogo Penalità</h3>
                    <p><strong>${taskCount}</strong> task non completate</p>
                    <p style="font-size:1.5em; color:#ff6b6b;">Penalità: <strong>-${totalPenalty} PP</strong></p>
                    <p>Punti dopo salvataggio: <strong>${newPoints} PP</strong></p>
                `;
            }
        }

        function clearSelection() {
            document.querySelectorAll('#tasksList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updatePenaltySummary();
        }

        function saveTasksForToday() {
            if (!selectedPerson) {
                alert('❌ Seleziona una persona!');
                return;
            }

            const date = document.getElementById('taskDate').value;
            const checkboxes = document.querySelectorAll('#tasksList input[type="checkbox"]:checked');
            let totalPenalty = 0;
            const incompleteTasks = [];

            checkboxes.forEach(cb => {
                totalPenalty += parseInt(cb.dataset.points);
                incompleteTasks.push(cb.dataset.task);
            });

            const data = getData();
            data[selectedPerson].history = data[selectedPerson].history.filter(h => h.date !== date);
            
            if (totalPenalty > 0) {
                data[selectedPerson].history.push({
                    date: date,
                    penalty: totalPenalty,
                    incompleteTasks: incompleteTasks
                });
            }

            data[selectedPerson].points = 500 - data[selectedPerson].history.reduce((sum, h) => sum + h.penalty, 0);
            saveData(data);
            
            alert(`✅ Salvato!\n\nPersona: ${selectedPerson}\nData: ${date}\nPenalità: -${totalPenalty} PP\nPunti attuali: ${data[selectedPerson].points} PP`);
            updatePenaltySummary();
        }

        function loadHistory() {
            const person = document.getElementById('historyPerson').value;
            const fromDate = document.getElementById('historyFromDate').value;
            const toDate = document.getElementById('historyToDate').value;
            
            const data = getData();
            let allHistory = [];

            if (person === 'all') {
                people.forEach(p => {
                    data[p].history.forEach(h => {
                        allHistory.push({ person: p, ...h });
                    });
                });
            } else {
                data[person].history.forEach(h => {
                    allHistory.push({ person: person, ...h });
                });
            }

            if (fromDate) allHistory = allHistory.filter(h => h.date >= fromDate);
            if (toDate) allHistory = allHistory.filter(h => h.date <= toDate);

            allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = '<div class="history-entries">';
            if (allHistory.length === 0) {
                html += '<p style="text-align:center; padding:20px;">Nessun dato trovato per i filtri selezionati</p>';
            } else {
                allHistory.forEach(entry => {
                    html += `
                        <div class="history-entry card">
                            <div class="history-header">
                                <strong>${entry.person}</strong>
                                <span>${new Date(entry.date).toLocaleDateString('it-IT')}</span>
                            </div>
                            <div class="history-penalty">Penalità: <strong>-${entry.penalty} PP</strong></div>
                            <div class="history-tasks">
                                <details>
                                    <summary>${entry.incompleteTasks.length} task non completate</summary>
                                    <ul>
                                        ${entry.incompleteTasks.map(t => `<li>${t}</li>`).join('')}
                                    </ul>
                                </details>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';
            document.getElementById('historyList').innerHTML = html;
        }

        function resetMonth() {
            if (!confirm('⚠️ Sei sicuro di voler resettare il mese?\n\nTutti i punti torneranno a 500 e lo storico verrà cancellato.')) return;

            const data = getData();
            people.forEach(person => {
                data[person].points = 500;
                data[person].history = [];
            });
            saveData(data);
            
            alert('✅ Mese resettato! Tutti ripartono da 500 punti.');
            renderTasks();
            updateLeaderboard();
            loadHistory();
        }

        // === ANALYTICS FUNCTIONS ===

        function loadAnalytics() {
            loadTeamHealthScore();
            loadAIInsights();
            loadTrendChart();
            loadHeatmapChart();
            loadWeekdayChart();
            loadComparisonChart();
            loadPredictions();
        }

        function loadTeamHealthScore() {
            const health = calculateTeamHealthScore();
            const color = health.score >= 80 ? '#00C853' : 
                         health.score >= 60 ? '#FFD600' : 
                         health.score >= 40 ? '#FF6D00' : '#D50000';
            
            document.getElementById('teamHealthScore').innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 5em; font-weight: bold; color: ${color};">${health.score}/100</div>
                    <div style="font-size: 1.5em; margin-top: 10px;">${health.rating}</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
                        <div class="health-component">
                            <div class="component-value">${Math.round(health.components.averagePerformance)}%</div>
                            <div class="component-label">Performance Media</div>
                        </div>
                        <div class="health-component">
                            <div class="component-value">${Math.round(health.components.worstPerformer)}%</div>
                            <div class="component-label">Performance Minima</div>
                        </div>
                        <div class="health-component">
                            <div class="component-value">${Math.round(health.components.teamMorale)}%</div>
                            <div class="component-label">Team Morale</div>
                        </div>
                        <div class="health-component">
                            <div class="component-value">${Math.round(health.components.consistency)}%</div>
                            <div class="component-label">Consistenza</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadAIInsights() {
            const insights = generateInsights();
            let html = '';
            
            if (insights.length === 0) {
                html = '<p style="text-align:center; opacity:0.7;">✨ Tutto sotto controllo! Nessun insight critico rilevato.</p>';
            } else {
                insights.forEach(insight => {
                    const bgColor = insight.type === 'error' ? 'rgba(213, 0, 0, 0.2)' :
                                   insight.type === 'warning' ? 'rgba(255, 214, 0, 0.2)' :
                                   insight.type === 'success' ? 'rgba(0, 200, 83, 0.2)' :
                                   'rgba(255, 255, 255, 0.1)';
                    
                    html += `
                        <div class="insight-card" style="background: ${bgColor}; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">${insight.icon}</div>
                            <h4 style="margin-bottom: 10px;">${insight.title}</h4>
                            <p>${insight.message}</p>
                        </div>
                    `;
                });
            }
            
            document.getElementById('aiInsights').innerHTML = html;
        }

        function loadTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (charts.trend) charts.trend.destroy();
            
            const datasets = people.map((person, idx) => {
                const trend = calculateTrend(person, 30);
                const colors = ['#667eea', '#f5576c', '#FFD700'];
                
                return {
                    label: person,
                    data: trend.dailyPoints.map(d => ({ x: d.date, y: d.points })),
                    borderColor: colors[idx],
                    backgroundColor: colors[idx] + '33',
                    tension: 0.4
                };
            });
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    scales: {
                        x: { type: 'time', time: { unit: 'day' } },
                        y: { beginAtZero: false, max: 500 }
                    }
                }
            });
        }

        function loadHeatmapChart() {
            const ctx = document.getElementById('heatmapChart');
            if (charts.heatmap) charts.heatmap.destroy();
            
            const heatmap = generateTaskHeatmap().slice(0, 10);
            
            charts.heatmap = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: heatmap.map(t => t.task.substring(0, 30) + '...'),
                    datasets: [{
                        label: 'Errori',
                        data: heatmap.map(t => t.errorCount),
                        backgroundColor: 'rgba(245, 87, 108, 0.7)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true
                }
            });
        }

        function loadWeekdayChart() {
            const ctx = document.getElementById('weekdayChart');
            if (charts.weekday) charts.weekday.destroy();
            
            const weekdayData = analyzeWeekdayPatterns();
            
            charts.weekday = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weekdayData.map(d => d.name),
                    datasets: [{
                        label: 'Errori',
                        data: weekdayData.map(d => d.count),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)'
                    }]
                },
                options: { responsive: true }
            });
        }

        function loadComparisonChart() {
            const ctx = document.getElementById('comparisonChart');
            if (charts.comparison) charts.comparison.destroy();
            
            const comparison = compareWeekOverWeek();
            
            charts.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: people,
                    datasets: [
                        {
                            label: 'Settimana Scorsa',
                            data: people.map(p => comparison[p].previousWeek.penalty),
                            backgroundColor: 'rgba(200, 200, 200, 0.7)'
                        },
                        {
                            label: 'Questa Settimana',
                            data: people.map(p => comparison[p].currentWeek.penalty),
                            backgroundColor: 'rgba(102, 126, 234, 0.7)'
                        }
                    ]
                },
                options: { responsive: true }
            });
        }

        function loadPredictions() {
            const predictions = predictEndOfMonth();
            let html = '<div style="display: grid; gap: 20px;">';
            
            people.forEach(person => {
                const pred = predictions[person];
                const change = pred.change;
                const arrow = change > 0 ? '📈' : change < 0 ? '📉' : '➡️';
                const color = change > 0 ? '#00C853' : change < 0 ? '#D50000' : '#FFD600';
                
                html += `
                    <div class="prediction-card" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <h3>${person}</h3>
                        <div style="display: flex; gap: 20px; align-items: center; margin-top: 15px;">
                            <div>
                                <div style="font-size: 0.9em; opacity: 0.8;">Ora</div>
                                <div style="font-size: 2em; font-weight: bold;">${pred.current}</div>
                            </div>
                            <div style="font-size: 3em;">${arrow}</div>
                            <div>
                                <div style="font-size: 0.9em; opacity: 0.8;">Fine Mese</div>
                                <div style="font-size: 2em; font-weight: bold; color: ${color};">${pred.predicted}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Livello previsto:</strong> ${pred.level}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('predictions').innerHTML = html;
        }

        function showRecommendations(person) {
            const recs = generatePersonalRecommendations(person);
            let html = '<div style="margin-top: 20px;">';
            
            if (recs.length === 0) {
                html += '<p style="text-align:center;">✨ Performance ottima! Nessuna raccomandazione specifica.</p>';
            } else {
                recs.forEach(rec => {
                    html += `
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                            <h4>${rec.icon} ${rec.title}</h4>
                            <div style="margin-top: 10px;">
                                ${rec.actions.join('<br>')}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('recommendations').innerHTML = html;
        }

        // Carica correlazioni al caricamento analytics
        window.addEventListener('load', () => {
            const correlationsDiv = document.getElementById('correlations');
            const correlations = findTaskCorrelations();
            
            if (correlations.length === 0) {
                correlationsDiv.innerHTML = '<p style="text-align:center; opacity:0.7;">Nessuna correlazione significativa trovata</p>';
            } else {
                let html = '<div style="display: grid; gap: 10px;">';
                correlations.forEach(corr => {
                    html += `
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                            <strong>"${corr.tasks[0]}"</strong> + <strong>"${corr.tasks[1]}"</strong>
                            <div style="opacity: 0.8; margin-top: 5px;">Saltate insieme ${corr.occurrences} volte</div>
                        </div>
                    `;
                });
                html += '</div>';
                correlationsDiv.innerHTML = html;
            }
        });

        // Inizializza quando il DOM è pronto
        document.addEventListener('DOMContentLoaded', function() {
            updateMonthDisplay();
            setTodayDate();
            updateLeaderboard();
        });
    </script>
</body>
</html>
