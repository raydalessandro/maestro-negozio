<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classifica Team - Maestro di Negozio</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Classifica del Mese</h1>
            <p class="subtitle">Chi sar√† il Maestro di Negozio?</p>
        </div>
    <div class="back-button">
        <button class="btn btn-secondary" onclick="goHome()">‚Üê Indietro</button>
    </div>

    <div id="leaderboard" class="leaderboard"></div>

    <div class="team-motivational card">
        <h3>üí™ Obiettivo del Mese</h3>
        <p>Raggiungi 450+ punti per diventare <strong>Maestro di Negozio</strong>!</p>
        <div class="benefits-list">
            <div class="benefit-item">‚ú® Budget extra per la gestione</div>
            <div class="benefit-item">üéñÔ∏è Menzione nell'organigramma aziendale</div>
            <div class="benefit-item">üèÖ Premio annuale di eccellenza</div>
        </div>
    </div>

    <div class="refresh-info">
        <p>üì± Aggiornamento automatico ogni 30 secondi</p>
        <button class="btn btn-primary" onclick="manualRefresh()">üîÑ Aggiorna Ora</button>
    </div>
</div>

<!-- Carica script nell'ordine corretto -->
<script src="assets/js/config.js"></script>
<script src="assets/js/github-storage.js"></script>
<script src="assets/js/data.js"></script>
<script src="assets/js/ui.js"></script>

<script>
    function showLoading(message = 'Caricamento...') {
        const loader = document.createElement('div');
        loader.id = 'app-loader';
        loader.innerHTML = `
            <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                backdrop-filter: blur(5px);
            ">
                <div style="
                    background: rgba(255, 255, 255, 0.15);
                    backdrop-filter: blur(10px);
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    border: 2px solid rgba(255, 255, 255, 0.2);
                ">
                    <div style="font-size: 3em; margin-bottom: 20px;">‚è≥</div>
                    <div style="font-size: 1.2em; color: white;">${message}</div>
                </div>
            </div>
        `;
        document.body.appendChild(loader);
    }

    function hideLoading() {
        const loader = document.getElementById('app-loader');
        if (loader) loader.remove();
    }

    function goHome() {
        window.location.href = 'index.html';
    }

    async function updateLeaderboardAsync() {
        try {
            const leaderboardDiv = document.getElementById('leaderboard');
            if (!leaderboardDiv) return;

            const rankings = await getLeaderboard();
            
            const html = rankings.map((player, idx) => {
                const emoji = levelEmojis[player.level.name] || 'üéØ';
                const progress = (player.points / INITIAL_POINTS) * 100;
                
                return `
                    <div class="player-card">
                        <div class="player-rank rank-${idx + 1}">${idx + 1}</div>
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-level">
                                <span class="level-badge">${emoji} ${player.level.name}</span>
                                <span>${player.points} / ${INITIAL_POINTS} PP</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <div class="player-stats">
                                <div class="stat">
                                    <div class="stat-value">${player.daysWithErrors}</div>
                                    <div class="stat-label">Giorni con Errori</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">-${player.totalPenalty}</div>
                                    <div class="stat-label">Penalit√† Totali</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">${player.pointsLost}</div>
                                    <div class="stat-label">Punti Persi</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            leaderboardDiv.innerHTML = html;
        } catch (error) {
            console.error('Errore aggiornamento classifica:', error);
            document.getElementById('leaderboard').innerHTML = `
                <div class="card" style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h3>Errore Caricamento</h3>
                    <p>Impossibile caricare la classifica.</p>
                    <button class="btn btn-primary" onclick="manualRefresh()" style="margin-top: 20px;">
                        üîÑ Riprova
                    </button>
                </div>
            `;
        }
    }

    async function manualRefresh() {
        showLoading('Aggiornamento...');
        
        // Invalida cache per forzare reload da GitHub
        if (typeof invalidateCache === 'function') {
            invalidateCache();
        }
        
        await updateLeaderboardAsync();
        hideLoading();
    }

    // Inizializza quando il DOM √® pronto
    document.addEventListener('DOMContentLoaded', async function() {
        showLoading('Caricamento classifica...');
        
        try {
            // Inizializza GitHub sync
            if (window.githubSync) {
                await window.githubSync.init();
            } else {
                throw new Error('GitHub sync non disponibile');
            }
            
            // Carica classifica iniziale
            await updateLeaderboardAsync();
            
            hideLoading();
            
            // Auto-refresh ogni 30 secondi
            setInterval(async function() {
                console.log('üîÑ Auto-refresh classifica...');
                await updateLeaderboardAsync();
            }, 30000);
            
            console.log('‚úÖ Classifica inizializzata');
            
        } catch (error) {
            hideLoading();
            
            alert(
                '‚ö†Ô∏è Errore Inizializzazione\n\n' +
                'Impossibile caricare la classifica.\n' +
                'Verifica la connessione internet e riprova.\n\n' +
                'Dettagli: ' + error.message
            );
            
            console.error('Init error:', error);
        }
    });
</script>
</body>
</html>
