<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classifica Team - Maestro di Negozio</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏆 Classifica del Mese</h1>
            <p class="subtitle">Chi sarà il Maestro di Negozio?</p>
        </div>

        <div class="back-button">
            <button class="btn btn-secondary" onclick="goHome()">← Indietro</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTeamTab('leaderboard')">🏆 Classifica</div>
            <div class="tab" onclick="switchTeamTab('feedback')">💭 Feedback</div>
        </div>

        <!-- TAB CLASSIFICA -->
        <div id="team-leaderboard" class="tab-content active">
            <div id="leaderboard" class="leaderboard"></div>

            <div class="team-motivational card">
                <h3>💪 Obiettivo del Mese</h3>
                <p>Raggiungi 450+ punti per diventare <strong>Maestro di Negozio</strong>!</p>
                <div class="benefits-list">
                    <div class="benefit-item">✨ Budget extra per la gestione</div>
                    <div class="benefit-item">🎖️ Menzione nell'organigramma aziendale</div>
                    <div class="benefit-item">🏅 Premio annuale di eccellenza</div>
                </div>
            </div>

            <div class="refresh-info">
                <p>📱 Aggiornamento automatico ogni 30 secondi</p>
                <button class="btn btn-primary" onclick="updateLeaderboard()">🔄 Aggiorna Ora</button>
            </div>
        </div>

        <!-- TAB FEEDBACK -->
        <div id="team-feedback" class="tab-content">
            <div class="card feedback-intro">
                <h2>💭 Il Tuo Feedback Conta</h2>
                <p style="opacity: 0.9; margin-top: 10px;">
                    La tua opinione è importante! Questo feedback è <strong>completamente anonimo</strong> 
                    e aiuta il management a migliorare l'ambiente di lavoro.
                </p>
            </div>

            <div class="card feedback-form">
                <h3>Come Ti Senti Oggi?</h3>
                <div class="mood-selector">
                    <div class="mood-option" data-mood="1" onclick="selectMood(1)">
                        <div class="mood-emoji">😞</div>
                        <div class="mood-label">Molto Male</div>
                    </div>
                    <div class="mood-option" data-mood="2" onclick="selectMood(2)">
                        <div class="mood-emoji">😕</div>
                        <div class="mood-label">Male</div>
                    </div>
                    <div class="mood-option" data-mood="3" onclick="selectMood(3)">
                        <div class="mood-emoji">😐</div>
                        <div class="mood-label">Ok</div>
                    </div>
                    <div class="mood-option" data-mood="4" onclick="selectMood(4)">
                        <div class="mood-emoji">🙂</div>
                        <div class="mood-label">Bene</div>
                    </div>
                    <div class="mood-option" data-mood="5" onclick="selectMood(5)">
                        <div class="mood-emoji">😃</div>
                        <div class="mood-label">Molto Bene</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Categoria (Opzionale)</h3>
                    <select id="feedbackCategory" class="feedback-select">
                        <option value="generale">Generale</option>
                        <option value="ambiente">Ambiente di Lavoro</option>
                        <option value="turni">Turni e Orari</option>
                        <option value="formazione">Formazione</option>
                        <option value="attrezzatura">Attrezzatura/Strumenti</option>
                        <option value="comunicazione">Comunicazione</option>
                        <option value="altro">Altro</option>
                    </select>
                </div>

                <div style="margin-top: 20px;">
                    <h3>Hai Suggerimenti o Commenti? (Opzionale)</h3>
                    <textarea 
                        id="feedbackMessage" 
                        class="feedback-textarea"
                        placeholder="Es: Servirebbe più tempo per l'inventario, oppure sarebbe utile avere una checklist cartacea...
                        
Ricorda: questo messaggio è completamente anonimo!"
                        rows="5"
                    ></textarea>
                    <p style="opacity: 0.7; font-size: 0.9em; margin-top: 10px;">
                        💡 Sii costruttivo: cosa funziona bene? Cosa si può migliorare?
                    </p>
                </div>

                <div class="action-buttons" style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="submitFeedback()" id="submitBtn">
                        📤 Invia Feedback Anonimo
                    </button>
                </div>
            </div>

            <div class="card feedback-stats">
                <h3>📊 Umore del Team</h3>
                <div id="teamMoodDisplay"></div>
            </div>
        </div>
    </div>

    <!-- Carica script nell'ordine corretto -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/supabase-storage.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/feedback.js"></script>
    
    <script>
        let selectedMoodValue = null;

        function goHome() {
            window.location.href = 'index.html';
        }

        function switchTeamTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById('team-' + tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'feedback') {
                updateTeamMoodDisplay();
            }
        }

        function selectMood(mood) {
            selectedMoodValue = mood;
            
            document.querySelectorAll('.mood-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            const selected = document.querySelector(`.mood-option[data-mood="${mood}"]`);
            if (selected) {
                selected.classList.add('selected');
            }
        }

        async function submitFeedback() {
            if (!selectedMoodValue) {
                alert('❌ Seleziona come ti senti prima di inviare!');
                return;
            }

            const message = document.getElementById('feedbackMessage').value.trim();
            const category = document.getElementById('feedbackCategory').value;
            
            const btn = document.getElementById('submitBtn');
            const originalText = btn.textContent;
            btn.textContent = '⏳ Invio in corso...';
            btn.disabled = true;

            const success = await saveFeedback(selectedMoodValue, message, category);
            
            if (success) {
                alert('✅ Grazie per il tuo feedback!\n\nIl tuo messaggio anonimo è stato inviato al management.');
                
                document.getElementById('feedbackMessage').value = '';
                document.getElementById('feedbackCategory').value = 'generale';
                document.querySelectorAll('.mood-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                selectedMoodValue = null;
                
                updateTeamMoodDisplay();
            }
            
            btn.textContent = originalText;
            btn.disabled = false;
        }

        async function updateTeamMoodDisplay() {
            const stats = await getTeamMoodStats();
            const container = document.getElementById('teamMoodDisplay');
            
            if (!container) return;
            
            const total = Object.values(stats).reduce((a, b) => a + b, 0);
            
            if (total === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.6;">Nessun feedback ancora. Sii il primo! 🚀</p>';
                return;
            }
            
            const moodEmojis = { 1: '😢', 2: '😟', 3: '😐', 4: '🙂', 5: '😄' };
            
            let html = '<div style="display: flex; justify-content: space-around; margin: 20px 0;">';
            
            Object.keys(stats).forEach(mood => {
                const count = stats[mood];
                const percentage = ((count / total) * 100).toFixed(0);
                
                html += `
                    <div style="text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 5px;">${moodEmojis[mood]}</div>
                        <div style="font-size: 1.2em; font-weight: 600; color: #E60000;">${percentage}%</div>
                        <div style="font-size: 0.8em; opacity: 0.6;">${count} voti</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            const avgMood = Object.keys(stats).reduce((sum, mood) => {
                return sum + (parseInt(mood) * stats[mood]);
            }, 0) / total;
            
            let moodText = '';
            if (avgMood >= 4.5) moodText = '🎉 Il team è super motivato!';
            else if (avgMood >= 3.5) moodText = '👍 Il morale è buono';
            else if (avgMood >= 2.5) moodText = '😐 Il team è nella media';
            else moodText = '⚠️ Il team ha bisogno di supporto';
            
            html += `<div style="text-align: center; font-size: 1.1em; font-weight: 600; color: #333; margin-top: 15px;">${moodText}</div>`;
            
            container.innerHTML = html;
        }

        async function getTeamMoodStats() {
            try {
                const config = window.SUPABASE_CONFIG;
                if (!config) return { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
                
                const response = await fetch(
                    `${config.url}/rest/v1/feedback_anonimi?select=mood`,
                    {
                        headers: {
                            'apikey': config.key,
                            'Authorization': `Bearer ${config.key}`
                        }
                    }
                );
                
                if (!response.ok) throw new Error('Errore caricamento');
                
                const data = await response.json();
                const moodCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
                data.forEach(f => {
                    if (moodCounts.hasOwnProperty(f.mood)) {
                        moodCounts[f.mood]++;
                    }
                });
                
                return moodCounts;
            } catch (error) {
                console.error('❌ Errore stats mood:', error);
                return { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (window.supabaseSync && window.supabaseSync.init) {
                window.supabaseSync.init().then(() => {
                    console.log('✅ Supabase sync team attiva');
                });
            }
            
            updateLeaderboard();
            updateTeamMoodDisplay();

            setInterval(function() {
                if (document.getElementById('team-leaderboard').classList.contains('active')) {
                    updateLeaderboard();
                }
            }, 30000);
        });
    </script>
</body>
</html>
